---
title: C文件I/O
date: 2017-06-11 10:16:00
tags: [C, I/O]
categories: [C, I/O]
---
IO 是每个程序中基本的操作, 而在大多数的文件I/O操作中, 只需要 5 个函数:
`open`, `read`, `write`, `lseek`, `close` 等. 简单的来说, 几个基本函数是系统调用, 
提供了文件IO的最原始的操作.

## 文件描述符

对内核而言, 所有打开的文件资源 **都是通过文件描述符** 引用. 文件描述符是一个 **非负整数**.
在打开/创建文件时, 内核会向进程返回对应的文件描述符, 而其也是 `read`, `write` 等的参数.

### 特殊的文件描述符

-  STDIN_FILENO(0): 标准输入
- STDOUT_FILENO(1): 标准输出
- STDERR_FILENO(2): 标准错误

值得注意的是, 虽然 0, 1, 2 已被标准化, 但在编码的时候最好还是使用 XX_FILENO 预定义常量.
常量预定义在 `<unistd.h>` 中.

## open

打开或创建一个文件, 函数原型如下:

``` C
# 成功: 返回最小未使用的文件描述符数值
# 失败: -1

int open(const char *path, int oflag, ...);

int openat(int fd, const char *path, int oflag, ...);
```

_path_ 参数为要打开或创建的文件的名称. flags 为该函数的选项, 一般为一个或
多个常量进行 "按位或" 运算构成, 可选值如下:

| 常量        | 说明                                                                                                     |
|-------------|----------------------------------------------------------------------------------------------------------|
| O_RDONLY    | 只读打开                                                                                                 |
| O_WRONLY    | 只写打开                                                                                                 |
| O_FDWR      | 读写打开                                                                                                 |
| O_APPEND    | 以追加模式打开该文件                                                                                     |
| O_CLOEXEC   | 在文件描述符上设置 FD_CLOEXEC 常量                                                                       |
| O_CREATE    | 如果文件不存在, 则创建                                                                                   |
| O_DIRECTORY | 如果 _path_ 不是一个文件夹, 则调用失败                                                                   |
| O_EXCL      | 如果同时设置了 O_CREAT 并且文件存在则出错                                                                |
| O_NOCTTY    | 如果 _path_ 引用的是终端设备, 则不将该设备分配作为此进程的控制终端                                       |
| O_NOFOLLOW  | 如果 _path_ 引用的是一个符号链接, 则出错                                                                 |
| O_NONBLOCK  | 非阻塞, 不等待数据可用                                                                                   |
| O_SYNC      | 使每次 write 等待物理 I/O 操作完成, 包括由该 write 操作引起的文件属性更新所需的 I/0                      |
| O_TRUNC     | 以写模式成功打开, 将文件长度截断为 0                                                                     |
| O_DSYNC     | 使每次 write 要等待物理 I/O 操作完成, 但是如果该写操作并不影响读取刚写入的数据, 则不需等待文件属性被更新 |
| O_RSYNC     | 使每一个以文件描述符作为参数进行的 read 操作等待, 直至所有对文件同一部分挂起的写操作都完成               |

其中, 前 3 者为打开模式, 必须并且只能设置一种, 余下的为附加选项, 可以通过 按位或 运算添加.
更多详细的描述, 可通过 `man 3 open` 来查看.

除非 _path_ 参数是一个相对路径, 否则 `openat` 与 `open` 调用的行为是完全一致的.
在这种情况下(_path_ 为相对路径), 待打开的文件所在的目录为 fd 文件所在的目录而不是当前目录;
如果 fd 为特殊值 AT_FDCWD, 则使用当前目录此时行为与 `open` 也是完全一致.

## 参考

- UNIX 环境高级编程(第三版)